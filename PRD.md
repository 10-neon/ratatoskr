# Ratatoskr 聊天辅助 App 需求文档（PRD）

## 背景与愿景
- 灵感来源：《约会大作战》中拉塔托斯克为士道实时推送“三选一”应对方案。
- 愿景：在即时聊天场景为用户生成多条候选回复，降低社交压力，提高回复质量与效率，尤其帮助社恐与自闭谱系用户。

## 目标与范围
- 目标：
  - 通过无障碍服务读取当前聊天内容及上下文。
  - 用户点击悬浮球后，将聊天内容推送给 AI，生成若干回复选项。
  - 用户点击选项后自动复制到剪贴板，由用户自主发送。
- 范围限定：
  - 不集成屏幕录制能力（不使用录屏模块）。
  - 初期只读聊天界面文本，不进行自动点击或自动发送。

## 用户画像与使用场景
- 用户画像：社恐/自闭谱系/社交压力较高的用户；希望获得低成本、高质量的回复建议。
- 典型场景：
  - 即时消息中的高压对话（工作沟通、初次社交）。
  - 需要兼顾礼貌、安全与推进关系的复杂语境。

## 核心流程
1. 基于 Assists 无障碍 API 读取聊天界面文本与部分上下文（如对方昵称、最近若干消息）。
2. 用户点击悬浮球 → 触发生成：将最新上下文发送至 AI。
3. AI 返回候选回复（默认 3 条：稳妥型、推进型、幽默/出其不意型；可扩展为 5 条）。
4. 在悬浮球附近弹出面板展示候选项。
5. 用户点击某一项 → 文本复制到剪贴板（不自动发送）。

## 功能需求
- 无障碍数据采集
  - 能够读取当前聊天窗口的文本节点，并合并为上下文字符串。
  - 提供去重、裁剪（如上限 2000 字符）与基础清洗。
- 悬浮球交互
  - 全局悬浮球（系统作用域），点击触发生成或展开/收起候选面板。
  - 候选面板在悬浮球附近弹出，支持点击空白处关闭。
- AI 生成接口
  - 输入：聊天上下文字符串、可选的对话元信息。
  - 输出：至少 3 条候选回复，标签或风格说明可选。
  - 超时与失败兜底：提供本地占位候选或提示重试。
- 剪贴板动作
  - 点击候选项将文本复制至系统剪贴板；弹出轻提示（如“已复制”）。
- 设置与开关
  - 开启/关闭悬浮球。
  - 候选条数设置（3/4/5）。
  - 风格偏好（稳妥/推进/幽默的权重）。

## 非功能需求
- 性能：
  - 点击悬浮球到候选展示的端到端平均延迟 ≤ 1500ms（网络条件正常）。
- 稳定性：
  - 无障碍读取在常见 IM 应用（如微信）界面的兼容性良好。
- 可用性：
  - UI 清晰、操作路径短，误触可快速撤销或关闭面板。

## 权限与合规
- 必需权限：
  - 无障碍服务权限（读取界面文本）。
  - 悬浮窗权限（显示全局悬浮球）。
  - 剪贴板访问权限。
- 隐私与合规：
  - 最小化上传内容；仅在用户主动触发时发送必要上下文到 AI。
  - 提供隐私说明与数据使用声明；支持本地生成或脱敏配置（后续版本）。

## 交互细节
- 悬浮球状态：
  - 默认显示“+”；生成中显示加载指示；展开时显示“−”。
- 候选项样式：
  - 列表按钮，支持 3–5 项；点击即复制，并关闭面板。
- 反馈：
  - 成功复制后 Toast/气泡提示；失败给出可重试提示。

## 失败与兜底
- 无障碍读取失败：提示开启权限或引导到系统设置。
- AI 超时/错误：展示兜底候选（本地模板）或提示稍后重试。
- 剪贴板失败：提示用户手动复制。

## MVP 范围（首版）
- 仅支持读取聊天文本并生成 3 条候选（稳妥/推进/幽默）。
- 支持悬浮球触发与候选面板展示，点击复制。
- 设置项：开关悬浮球、候选条数（3/4/5）。
- 不包含：屏幕录制、自动发送、复杂情感分析与多轮记忆。

## 里程碑（后续）
- v1.1：可选风格权重与个性化提示；更好的上下文裁剪。
- v1.2：多应用适配与节点稳健解析；离线/边缘生成探索。
- v1.3：对话历史缓存与轻量个性化语气配置。

## 技术提示（实现参考）
- 无障碍实现：
  - 基于 Assists 开源库的封装 API（assists-base），通过其节点查询与窗口管理能力读取聊天文本。
  - 仅使用读取能力；不执行点击/滑动/自动发送等自动化动作。
  - 服务注册在主模块 AndroidManifest.xml，android.permission.BIND_ACCESSIBILITY_SERVICE 与 meta-data 配置按示例。
- 浮窗实现：
  - 沿用现有 FloatingX + Compose 作为悬浮球与面板展示；也可替换为 Assists 的浮窗管理器（后续评估）。
- 库集成：
  - 仓库：JitPack；依赖：com.github.ven-coder.Assists:assists-base:v3.2.11。
- 关键接口：
  - 采集：使用 Assists 的无障碍 API 从当前窗口根节点聚合文本为上下文。
  - 生成：将上下文传入 AI，返回候选列表。
  - 展示：悬浮球附近的候选面板；点击复制。

## 成功度量
- 用户点击悬浮球次数、候选生成成功率与耗时。
- 候选点击率、复制成功率。
- 错误率（权限、网络、解析失败）。
